version = 0.1
default-task = 'test'

extensions = [
  'chomp@0.1:assert',
	'chomp@0.1:babel',
	'chomp@0.1:jspm',
  'chomp@0.1:ncc',
  'chomp@0.1:prettier',
	'chomp@0.1:rollup',
  'chomp@0.1:svelte',
  'chomp@0.1:swc',
]

[template-options.npm]
auto-install = true

[[task]]
name = 'test'
serial = true
deps = ['test:init', 'prettier', 'jspm', 'svelte', 'swc', 'babel', 'rollup', 'ncc']

[[task]]
name = 'check'
deps = ['app-build.html', 'lib-swc/test.js', 'test-babel.js']
engine = 'node'
run = '''
  import { readFileSync } from 'fs';
  import assert from 'assert';

  const log = readFileSync('testlog.txt', 'utf8').trim().split(/\r?\n/);
  assert.equal(log.length, 2);
  assert(log.indexOf('unit test a') !== -1);
  assert(log.indexOf('unit test b') !== -1);

  console.log('TESTS OK');
'''

[[task]]
name = 'test:init'
validation = 'none'
run = 'rm -r output'

[[task]]
name = 'prettier'
template = 'prettier'

[[task]]
name = 'jspm'
target = 'output/app-build.html'
dep = 'fixtures/app.html'
template = 'assert'
[task.template-options]
task-template = 'jspm'
expect-match = '''
<!DOCTYPE html>
<!-- Generated by @jspm/generator - https://github.com/jspm/generator -->
<script async src="https://ga\.jspm\.io/npm:es-module-shims@\d+.\d+.\d+/dist/es-module-shims\.js" crossorigin="anonymous"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://ga\.jspm\.io/npm:react@\d+.\d+.\d+/index\.js"
  }
}
</script>
<script type="module">
  import \* as React from "react";
  console.log\(React, oooi\);
</script>
'''

[[task]]
name = 'svelte'
target = 'output/test.js'
deps = ['fixtures/test.svelte']
template = 'assert'
[task.template-options]
task-template = 'svelte'
expect-pattern = '''/\* fixtures/test.svelte generated by Svelte * \*/
import {
	SvelteComponent,
	append,
	attr,
	detach,
	element,
	init,
	insert,
	listen,
	noop,
	safe_not_equal,
	set_data,
	space,
	text
} from "svelte/internal";

function create_fragment(ctx) {
	let div2;
	let div0;
	let t1;
	let div1;
	let t2;
	let t3;
	let button;
	let mounted;
	let dispose;

	return {
		c() {
			div2 = element("div");
			div0 = element("div");
			div0.textContent = "Message:";
			t1 = space();
			div1 = element("div");
			t2 = text(/\*msg\*/ ctx[0]);
			t3 = space();
			button = element("button");
			button.textContent = "Change Message";
			attr(div1, "class", "message svelte-1sryeut");
			attr(div2, "class", "container svelte-1sryeut");
		},
		m(target, anchor) {
			insert(target, div2, anchor);
			append(div2, div0);
			append(div2, t1);
			append(div2, div1);
			append(div1, t2);
			insert(target, t3, anchor);
			insert(target, button, anchor);

			if (!mounted) {
				dispose = listen(button, "click", /\*click_handler\*/ ctx[1]);
				mounted = true;
			}
		},
		p(ctx, [dirty]) {
			if (dirty & /\*msg\*/ 1) set_data(t2, /\*msg\*/ ctx[0]);
		},
		i: noop,
		o: noop,
		d(detaching) {
			if (detaching) detach(div2);
			if (detaching) detach(t3);
			if (detaching) detach(button);
			mounted = false;
			dispose();
		}
	};
}

function instance($$self, $$props, $$invalidate) {
	let msg = "hello";
	const click_handler = () => $$invalidate(0, msg = msg + " hello");
	return [msg, click_handler];
}

class Test extends SvelteComponent {
	constructor(options) {
		super();
		init(this, options, instance, create_fragment, safe_not_equal, {});
	}
}

export default Test;'''

[[task]]
name = 'swc'
deps = ['output/lib-swc/test.js', 'output/lib-swc/*.js']
template = 'assert'
[task.template-options]
expect-equals = """
import { dep } from "./dep.js";
console.log(dep);
export var p = 5;\n\n\n//# sourceMappingURL=test.js.map
"""

[[task]]
template = 'swc'
target = 'output/lib-swc/#.js'
dep = 'fixtures/src-swc/#.ts'

[[task]]
name = 'babel'
target = 'output/test-babel.js'
deps = ['fixtures/test.ts']
template = 'assert'
[task.template-options.task-template-options]
presets = ['@babel/preset-typescript']
[task.template-options]
task-template = 'babel'
expect-equals = """
export var p = 5;\n\n//# sourceMappingURL=test-babel.js.map
"""

[[task]]
name = 'rollup'
target = 'output/rollup-dist/test.js'
deps = ['output/lib-swc/*.js']
template = 'assert'
[task.template-options.task-template-options]
outdir = 'output/rollup-dist'
entries = ['output/lib-swc/test.js']
[task.template-options]
task-template = 'rollup'
expect-equals = '''
const dep = "dep";

console.log(dep);
var p = 5;

export { p };
//# sourceMappingURL=test.js.map
'''

[[task]]
name = 'ncc'
target = 'output/ncc/build.js'
dep = 'fixtures/app.js'
template = 'assert'
[task.template-options.task-template-options]
sourceMap = true
[task.template-options]
task-template = 'ncc'
expect-equals = """
/******/ (() => { // webpackBootstrap
/******/ \tvar __webpack_modules__ = ({});
/************************************************************************/
/******/ \t// The module cache
/******/ \tvar __webpack_module_cache__ = {};
/******/ \t
/******/ \t// The require function
/******/ \tfunction __nccwpck_require__(moduleId) {
/******/ \t\t// Check if module is in cache
/******/ \t\tvar cachedModule = __webpack_module_cache__[moduleId];
/******/ \t\tif (cachedModule !== undefined) {
/******/ \t\t\treturn cachedModule.exports;
/******/ \t\t}
/******/ \t\t// Create a new module (and put it into the cache)
/******/ \t\tvar module = __webpack_module_cache__[moduleId] = {
/******/ \t\t\t// no module.id needed
/******/ \t\t\t// no module.loaded needed
/******/ \t\t\texports: {}
/******/ \t\t};
/******/ \t
/******/ \t\t// Execute the module function
/******/ \t\tvar threw = true;
/******/ \t\ttry {
/******/ \t\t\t__webpack_modules__[moduleId](module, module.exports, __nccwpck_require__);
/******/ \t\t\tthrew = false;
/******/ \t\t} finally {
/******/ \t\t\tif(threw) delete __webpack_module_cache__[moduleId];
/******/ \t\t}
/******/ \t
/******/ \t\t// Return the exports of the module
/******/ \t\treturn module.exports;
/******/ \t}
/******/ \t
/************************************************************************/
/******/ \t/* webpack/runtime/compat */
/******/ \t
/******/ \tif (typeof __nccwpck_require__ !== 'undefined') __nccwpck_require__.ab = __dirname + "/";
/******/ \t
/************************************************************************/
var __webpack_exports__ = {};
console.log(readFileSync(__nccwpck_require__.ab + "asset.txt"));

module.exports = __webpack_exports__;
/******/ })()
;
//# sourceMappingURL=app.js.map
"""
